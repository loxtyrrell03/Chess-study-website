<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Skillflow — Structure your training. Master any skill.</title>
  <meta name="color-scheme" content="light dark"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./styles.css"/>
  <style id="index-overrides">
    /* ----- Progress highlight layering + stronger fill ----- */
    #progressSegments{ z-index:0 !important; }
    #progressFill{
      z-index:2 !important;
      background:linear-gradient(90deg,var(--accent-100),color-mix(in srgb,var(--accent) 55%, transparent)) !important;
      border-right:2px solid var(--accent-600) !important;
    }
    #progressTicks{ z-index:3 !important; }
    #scrubOverlay{ z-index:4 !important; }

    /* ----- Reorder placeholder (Home outline) ----- */
    .drop-placeholder{
      opacity:.6;
      border:2px dashed var(--accent);
      background:color-mix(in srgb, var(--accent-100) 60%, transparent);
      height:var(--ph,44px);
      border-radius:10px;
      margin:.125rem 0;
    }
    .outline-row.dragging{ opacity:.35; }
  </style>
</head>
<body class="min-h-screen">
<div class="max-w-7xl mx-auto px-5 py-6">

  <!-- Header -->
  <header class="mb-4 flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Skillflow</h1>
      <p class="text-sm muted -mt-1">Structure your training. Master any skill.</p>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <button id="settingsBtn" class="px-3 py-2 rounded-xl border border-[var(--border)]" title="Customize UI">⚙️ Settings</button>

      <div id="authArea" class="flex items-center gap-2">
        <button id="authOpenBtn" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white">Sign in / Sign up</button>
        <div id="userBadge" class="hidden items-center gap-2">
          <span id="userEmail" class="text-sm muted"></span>
          <button id="signOutBtn" class="px-3 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white">Sign out</button>
        </div>
      </div>

      <span id="cloudStatus" class="text-xs muted">Local mode</span>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="mb-6">
    <div class="tabs-bar">
      <button class="tab-link active" data-tab="homeTab">Home</button>
      <div class="tab-sep"></div>
      <button class="tab-link" data-tab="savedTab">Saved Outlines</button>
      <div class="tab-sep"></div>
      <button class="tab-link" data-tab="helpTab">How to use</button>
    </div>
  </nav>

  <!-- HOME -->
  <section id="homeTab">
    <!-- Progress -->
    <section class="mb-4">
      <div class="flex items-center justify-between mb-1">
        <div class="block-sub">Progress — click to jump</div>
        <div id="progressPct" class="text-xs muted">0%</div>
      </div>
      <div id="progressHost" class="relative w-full h-6 rounded-2xl overflow-hidden card">
        <div id="progressFill" class="absolute left-0 top-0 bottom-0 transition-[width]" style="width:0%"></div>
        <div id="progressSegments" class="absolute inset-0 flex"></div>
        <div id="progressTicks" class="absolute inset-0 pointer-events-none"></div>
        <div id="scrubOverlay" class="absolute inset-0 cursor-pointer"></div>
      </div>
      <div id="legend" class="mt-2 flex flex-wrap gap-2 text-sm"></div>
    </section>

    <!-- Controls -->
    <section class="flex flex-wrap items-center gap-3 mb-3">
      <button id="startBtn" class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 text-white shadow-sm">Start Study Session</button>

      <!-- One-time gate shown right when a section completes -->
      <button id="readyNextBtn" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white shadow-sm hidden">
        I’m ready — start next ▶
      </button>

      <button id="prevBtn" class="px-3 py-2 rounded-xl border border-[var(--border)]">◀ Prev</button>
      <button id="nextBtn" class="px-3 py-2 rounded-xl border border-[var(--border)]">Next ▶</button>
      <button id="resetBtn" class="ml-auto px-3 py-2 rounded-xl border border-[var(--border)]">Reset</button>
      <button id="showOutlineBtn" class="px-3 py-2 rounded-xl border border-[var(--border)] hidden">Show Outline ▸</button>
    </section>

    <div id="split">
      <!-- LEFT -->
      <section id="leftPane">
        <div class="card p-6 section-card">
          <div class="flex items-center justify-between gap-3 border-b border-[var(--border)] pb-3">
            <div>
              <!-- Removed “Current Section” header per request -->
              <h2 id="currentTitle" class="text-2xl font-extrabold">—</h2>
            </div>
            <div class="flex items-center gap-2">
              <button id="editSectionBtn" class="px-3 py-2 rounded-xl border border-[var(--border)] text-sm">Edit Section</button>
              <div id="clock" class="clock-badge text-2xl tabular-nums">00:00</div>
            </div>
          </div>

          <!-- Shelf (Home) -->
          <div id="shelfWrap" class="mt-4 hidden">
            <div class="flex items-center justify-between">
              <h3 class="block-title">Widget shelf</h3>
              <div class="flex items-center gap-2">
                <button id="addWidgetBtn" class="btn-xs">+ New Widget</button>
                <button id="resetShelfBtn" class="btn-xs">Reset Shelf</button>
              </div>
            </div>
            <div id="linkShelf" class="mt-2 editor-shelf"></div>
            <div class="text-xs muted mt-1">Drag from shelf → links below. Click any item to edit.</div>
          </div>

          <!-- Links in current -->
          <div id="linksWrap" class="mt-4">
            <div class="flex items-center justify-between">
              <h3 class="block-title">Links</h3>
              <button id="clearSectionLinks" class="btn-xs hidden">Clear</button>
            </div>
            <!-- Use the same styling as Saved Outlines -->
            <div id="links" class="section-links-bar mt-2"></div>
          </div>

          <!-- Notes -->
          <div class="mt-4">
            <label class="block-title">Section notes</label>
            <p class="text-xs muted -mt-1 mb-1">Optional mini-checklist or reminders.</p>
            <textarea id="sectionDesc" class="w-full mt-1 input text-sm" placeholder="Add notes, mini-checklist, links…"></textarea>
          </div>
        </div>
      </section>

      <!-- HANDLE -->
      <div id="splitHandle"></div>

      <!-- RIGHT -->
      <aside id="rightPane">
        <div class="card p-4 h-full flex flex-col">

          <!-- Quick load -->
          <div id="homeSavedRow" class="mb-3">
            <div class="flex items-center justify-between">
              <h4 class="block-title">Saved Outlines</h4>
              <button id="manageOutlinesLink" class="text-xs underline" data-tab-jump="savedTab">Manage</button>
            </div>
            <div id="homeSavedScroller" class="mt-2 flex gap-2 overflow-x-auto p-2 rounded-xl border border-[var(--border)] bg-[var(--panel)]"></div>
          </div>

          <div class="flex items-center justify-between">
            <h3 class="block-title">Session outline</h3>
            <button id="collapseOutlineBtn" class="text-xs px-2 py-1 rounded-md border border-[var(--border)]">▾ Hide</button>
          </div>

          <ul id="outline" class="mt-3 flex-1 overflow-auto"></ul>

          <!-- Inline Add -->
          <div id="inlineAddRow" class="mt-2 hidden">
            <div class="flex flex-wrap items-center gap-2">
              <input id="addTitleInput" class="input flex-1" placeholder="Section title"/>
              <input id="addMinsInput" class="input w-28" type="number" min="0.25" step="0.25" placeholder="Minutes"/>
              <button id="addConfirmBtn" class="btn-xs">Add</button>
              <button id="addCancelBtn" class="btn-xs">Cancel</button>
            </div>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <button id="addOutlineItem" class="px-3 py-2 rounded-xl border border-[var(--border)] text-sm">+ Add Section</button>
            <div id="totalMins" class="ml-auto text-xs muted">Total: 0 minutes</div>
          </div>
        </div>
      </aside>
    </div>

    <footer class="mt-10 text-center text-xs muted">
      Skillflow — minimal, keyboard-friendly session manager. ♟️
    </footer>
  </section>

  <!-- SAVED OUTLINES -->
  <section id="savedTab" class="hidden">
    <div id="mergeBar" class="card p-4 mb-4" style="display:none">
      <div class="flex flex-col gap-2">
        <div class="text-sm">Merge <strong id="mergeSourceName"></strong> ➕ <strong id="mergeTargetName"></strong></div>
        <div class="flex flex-wrap items-center gap-2">
          <label class="text-sm muted">New outline name</label>
          <input id="mergeTitleInput" class="input flex-1" placeholder="e.g. ‘Balanced + Openings’"/>
          <button id="mergeConfirmBtn" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm">Merge</button>
          <button id="mergeCancelBtn" class="px-3 py-2 rounded-xl border border-[var(--border)] text-sm">Cancel</button>
        </div>
        <div class="text-xs muted">Original outlines are kept. Sections from the dragged outline are appended after the target’s sections.</div>
      </div>
    </div>

    <div class="mb-3 flex items-center gap-2">
      <button id="createOutlineBtn" class="px-3 py-2 rounded-xl border border-[var(--border)] text-sm">+ Create new outline</button>
      <div id="createOutlineForm" class="card p-4 mb-0 hidden">
        <label class="text-sm">Outline title</label>
        <div class="mt-2 flex items-center gap-2">
          <input id="newOutlineTitle" class="input flex-1" placeholder="e.g., 90-min Balanced Plan"/>
          <button id="createOutlineConfirm" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm">Create</button>
          <button id="createOutlineCancel" class="px-3 py-2 rounded-xl border border-[var(--border)] text-sm">Cancel</button>
        </div>
      </div>
    </div>

    <div class="text-sm muted mb-3">Tip: drag one outline card onto another to propose a merge (only when NOT editing).</div>
    <div id="savedList" class="grid lg:grid-cols-2 gap-4"></div>
  </section>

  <!-- HELP -->
  <section id="helpTab" class="hidden">
    <div class="card p-5">
      <h3 class="block-title mb-2">How to use</h3>
      <ol class="list-decimal pl-6 space-y-1 text-sm">
        <li>Create or load a saved outline on the right.</li>
        <li>Start the session timer, then jump between sections using the progress bar or outline.</li>
        <li>Edit links/notes for the current section with “Edit Section”.</li>
        <li>In Saved Outlines, drag a plan onto another to merge them.</li>
        <li>Open ⚙️ Settings to tweak theme and defaults.</li>
      </ol>
    </div>
  </section>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal hidden" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-panel max-w-[680px]" role="dialog" aria-modal="true">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Appearance</h3>
      <button class="btn-xxs" data-close="1">✕</button>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <label class="flex flex-col gap-1"><span class="text-sm">Background</span><input id="setBg" type="color" class="input h-10 p-1"/></label>
      <label class="flex flex-col gap-1"><span class="text-sm">Text</span><input id="setFg" type="color" class="input h-10 p-1"/></label>
      <label class="flex flex-col gap-1"><span class="text-sm">Accent</span><input id="setAccent" type="color" class="input h-10 p-1"/></label>
      <label class="flex flex-col gap-1"><span class="text-sm">Border</span><input id="setBorder" type="color" class="input h-10 p-1"/></label>
      <label class="flex flex-col gap-1"><span class="text-sm">Border width (px)</span><input id="setBorderW" type="number" min="0" max="6" step="1" class="input"/></label>
      <label class="col-span-2 flex items-center gap-2 mt-1">
        <input id="setFocusDefault" type="checkbox"/> <span>Start in focus mode by default</span>
      </label>
    </div>
    <div class="mt-4 flex items-center justify-between">
      <button id="settingsResetBtn" class="px-3 py-2 rounded-xl border border-[var(--border)]">Reset defaults</button>
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 rounded-xl border border-[var(--border)]" data-close="1">Cancel</button>
        <button id="settingsSaveBtn" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="authModal" class="modal hidden" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-panel max-w-[520px]" role="dialog" aria-modal="true">
    <div class="mb-4">
      <div class="flex items-center justify-between">
        <h3 id="authTitle" class="text-xl font-semibold">Welcome back</h3>
        <button class="btn-xxs" data-close="1">✕</button>
      </div>
      <p id="authSubtitle" class="text-sm muted mt-1">Sign in to sync your data across devices.</p>
    </div>

    <div class="space-y-3">
      <button id="googleBtn" class="w-full px-3 py-2 rounded-xl border border-[var(--border)] flex items-center justify-center gap-2">
        <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> Continue with Google
      </button>

      <div class="auth-sep"><span>or</span></div>

      <div id="emailFields" class="grid gap-2">
        <input id="emailInput" type="email" class="input" placeholder="Email"/>
        <input id="passInput" type="password" class="input" placeholder="Password"/>
      </div>

      <div id="signinRow" class="flex flex-wrap gap-3 justify-center">
        <button id="emailSignInBtn" class="px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 text-white btn-wide">Sign in</button>
        <button id="emailResetBtn" class="px-3 py-2 rounded-xl border border-[var(--border)] btn-wide">Reset password</button>
      </div>

      <div id="signupRow" class="hidden flex justify-center">
        <button id="emailSignUpBtn" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white btn-wide">Create account</button>
      </div>

      <div class="text-sm text-center mt-2">
        <span id="toggleAuthMode" class="underline cursor-pointer">New here? Create an account</span>
      </div>
    </div>
  </div>
</div>

<!-- App -->
<script type="module">
  /*************** Firebase ***************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import {
    getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  import { setupSavedOutlines } from "./saved-outlines.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAMyUlfqqOlnt-kHO-C-vB_rzJ-9eudxck",
    authDomain: "chessstudyplanner.firebaseapp.com",
    projectId: "chessstudyplanner",
    storageBucket: "chessstudyplanner.firebasestorage.app",
    messagingSenderId: "73363049381",
    appId: "1:73363049381:web:48da4a1e06b9744fccf64c",
    measurementId: "G-8PE090JLZH"
  };
  const app = initializeApp(firebaseConfig);
  getAnalytics(app);

  /*************** Local state + helpers ***************/
  const saveJSON = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const loadJSON = (k)=> { try{ return JSON.parse(localStorage.getItem(k)); }catch{ return null } };
  const $ = (q)=> document.querySelector(q);

  // Primary state
  let currentSession = loadJSON('current_session_v1') || [];
  let sectionNotes   = loadJSON('section_notes_v1') || {};
  let widgetShelf    = loadJSON('linkShelf_v1')    || [
    { id:'w_lichess',  label:'Lichess',          url:'https://lichess.org',          icon:'img',   img:'https://lichess1.org/assets/logo/lichess-favicon-256.png' },
    { id:'w_analysis', label:'Lichess Analysis', url:'https://lichess.org/analysis', icon:'img',   img:'https://lichess1.org/assets/logo/lichess-favicon-256.png' },
    { id:'w_chessable',label:'Chessable',        url:'https://www.chessable.com',    icon:'emoji', emoji:'📘' }
  ];
  let prefs = loadJSON('prefs_v1') || { splitRatio:56, outlineCollapsed:false, focusDefault:false, theme:{ bg:'#ffffff', fg:'#0f172a', accent:'#0ea5e9', border:'#94a3b8', borderW:2 } };
  let savedOutlines = loadJSON('saved_outlines_v1') || [];
  let timerState = loadJSON('timer_state_v2') || { sessionStarted:false, running:false, currentIndex:0, secondsLeft:0, outlineId:null, lastSyncTs:0, awaitingNext:false };

  // Cloud
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider(); provider.setCustomParameters({ prompt: "select_account" });
  const cloudStatus = $('#cloudStatus');
  let currentUser = null;
  const userDocRef = (uid)=> doc(db, 'users', uid, 'apps', 'chess_planner_v2');

  const debounce = (fn,ms=1000)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
  let dirty = false;
  const markDirty = ()=> { dirty = true; };
  const setLocalMode = (m='Local mode')=> cloudStatus.textContent = m;
  const setCloudMode = (m='Cloud sync on')=> cloudStatus.textContent = m;

  const saveCloudDebounced = debounce(async ()=>{
    if(!currentUser) return;
    try{
      await setDoc(userDocRef(currentUser.uid), {
        currentSession, notes: sectionNotes, prefs, widgetShelf, savedOutlines,
        timer: timerState, updatedAt: serverTimestamp(), sessions: deleteField(), activePreset: deleteField()
      }, { merge:true });
      cloudStatus.textContent = 'Saved to cloud ✓';
      dirty = false;
    }catch(e){ cloudStatus.textContent='Cloud save failed'; }
  }, 1200);

  const touchCloud = ()=> { if(currentUser){ saveCloudDebounced(); } };

  // Periodic flush
  setInterval(()=>{ if(currentUser && dirty) saveCloudDebounced(); }, 5000);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden'){ if(currentUser) saveCloudDebounced(); } });
  window.addEventListener('beforeunload', ()=>{ if(currentUser) saveCloudDebounced(); });

  // Local save wrappers
  const saveCurrentSession = ()=>{ saveJSON('current_session_v1', currentSession); markDirty(); touchCloud(); };
  const saveNotes          = ()=>{ saveJSON('section_notes_v1', sectionNotes);     markDirty(); touchCloud(); };
  const saveShelf          = ()=>{ saveJSON('linkShelf_v1', widgetShelf);         markDirty(); touchCloud(); };
  const savePrefs          = ()=>{ saveJSON('prefs_v1', prefs);                   markDirty(); touchCloud(); };
  const saveOutlinesLocal  = ()=>{ saveJSON('saved_outlines_v1', savedOutlines);  markDirty(); touchCloud(); };
  const saveTimerLocal     = ()=>{ saveJSON('timer_state_v2', timerState);        markDirty(); touchCloud(); };

  /*************** Tabs ***************/
  const tabButtons=[...document.querySelectorAll('.tab-link')];
  const homeTab=$('#homeTab'); const savedTab=$('#savedTab'); const helpTab=$('#helpTab');
  tabButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id=btn.dataset.tab;
      homeTab.classList.toggle('hidden', id!=='homeTab');
      savedTab.classList.toggle('hidden', id!=='savedTab');
      helpTab.classList.toggle('hidden', id!=='helpTab');
      if(id==='savedTab') renderSavedOutlines();
      if(id==='homeTab') renderHomeSavedBar();
    });
  });
  document.querySelectorAll('[data-tab-jump]').forEach(b=> b.onclick = ()=> document.querySelector(`.tab-link[data-tab="${b.dataset.tabJump}"]`)?.click());

  /*************** Progress / Timer ***************/
  const startBtn = $('#startBtn'); const prevBtn=$('#prevBtn'); const nextBtn=$('#nextBtn'); const resetBtn=$('#resetBtn');
  const readyNextBtn = $('#readyNextBtn');

  const currentTitleEl = $('#currentTitle'); const sectionDescEl=$('#sectionDesc'); const linksDiv=$('#links');
  const linkShelfDiv=$('#linkShelf'); const shelfWrap=$('#shelfWrap'); const editSectionBtn=$('#editSectionBtn'); const clearSectionLinksBtn=$('#clearSectionLinks');
  const addWidgetBtn=$('#addWidgetBtn'); const resetShelfBtn=$('#resetShelfBtn');

  const outline=$('#outline'); const addOutlineItemBtn=$('#addOutlineItem'); const inlineAddRow=$('#inlineAddRow');
  const addTitleInput=$('#addTitleInput'); const addMinsInput=$('#addMinsInput'); const addConfirmBtn=$('#addConfirmBtn'); const addCancelBtn=$('#addCancelBtn');
  const totalMins=$('#totalMins'); const clockEl=$('#clock');

  const progressHost=$('#progressHost'), progressFill=$('#progressFill'), progressSegments=$('#progressSegments'),
        progressTicks=$('#progressTicks'), progressPctEl=$('#progressPct'), legend=$('#legend'), scrubOverlay=$('#scrubOverlay');

  // Split panes (drag-to-resize)
  const splitEl = $('#split'), leftPane = $('#leftPane'), rightPane = $('#rightPane'), splitHandle = $('#splitHandle');
  function applySplitRatio(r){ splitEl.style.setProperty('--leftRatio', (r||56) + '%'); }
  applySplitRatio(prefs.splitRatio||56);
  let draggingSplit=false, splitLast= prefs.splitRatio||56;
  splitHandle.addEventListener('pointerdown', (e)=>{
    draggingSplit=true;
    splitHandle.setPointerCapture(e.pointerId);
    document.body.classList.add('no-select');
    onSplitMove(e);
  });
  splitHandle.addEventListener('pointermove', (e)=>{ if(draggingSplit) onSplitMove(e); });
  splitHandle.addEventListener('pointerup', ()=>{
    if(!draggingSplit) return;
    draggingSplit=false;
    document.body.classList.remove('no-select');
    prefs.splitRatio = Math.round(splitLast*10)/10;
    savePrefs();
  });
  function onSplitMove(e){
    const rect = splitEl.getBoundingClientRect();
    const x = Math.max(rect.left, Math.min(e.clientX, rect.right));
    const total = rect.width;
    const minPx = 360; // match CSS min-width
    const minPct = (minPx/total)*100;
    let pct = ((x - rect.left)/total)*100;
    pct = Math.max(minPct, Math.min(100 - minPct, pct));
    splitLast = pct;
    applySplitRatio(pct);
  }

  function minsToSecs(m){ return Math.max(0, Math.round(m*60)); }
  function secsToClock(s){ const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(Math.floor(s%60)).padStart(2,'0'); return `${mm}:${ss}`; }
  function scheduleTotalSecs(s){ return s.reduce((a,b)=>a+minsToSecs(b.minutes||0),0); }
  function elapsedSeconds(sched, idx, secsLeft){ const past=sched.slice(0,idx).reduce((a,b)=>a+minsToSecs(b.minutes||0),0); const cur=sched[idx]?minsToSecs(sched[idx].minutes||0)-secsLeft:0; return past+cur; }

  let running=false, rafId=null, endTimeMs=null, secondsLeft=0, currentIndex=0, sessionStarted=false, totalSessionSecs=0, awaitingNext=false;

  function isAtVeryStart(){
    if(!currentSession.length) return true;
    return elapsedSeconds(currentSession, currentIndex, secondsLeft) === 0;
  }
  function updateClockColor(){
    clockEl.classList.remove('text-emerald-600','text-rose-600');
    if(sessionStarted){ (running?clockEl.classList.add('text-emerald-600'):clockEl.classList.add('text-rose-600')); }
  }
  function updateStartBtnLabel(){
    if(running){ startBtn.textContent='Pause Session'; }
    else if(isAtVeryStart()){ startBtn.textContent='Start Study Session'; }
    else { startBtn.textContent='Resume Session'; }
    startBtn.disabled = !!awaitingNext;
  }
  function setTimerFromState(st){
    sessionStarted=!!st.sessionStarted; running=false; currentIndex=st.currentIndex||0; secondsLeft=Math.max(0,Math.round(st.secondsLeft||0));
    awaitingNext = !!st.awaitingNext;
    if(st.running && st.lastSyncTs){
      let delta=Math.floor((Date.now()-st.lastSyncTs)/1000), idx=currentIndex, remain=secondsLeft;
      while(delta>0 && currentSession[idx]){
        if(delta>=remain){ delta-=remain; idx++; remain=currentSession[idx]?minsToSecs(currentSession[idx].minutes||0):0; }
        else{ remain-=delta; delta=0; }
      }
      currentIndex=Math.min(idx, Math.max(0,currentSession.length-1)); secondsLeft=Math.max(0,remain||0);
    }
    totalSessionSecs=scheduleTotalSecs(currentSession);
    renderAll();
    if(awaitingNext) showNextGate(); else hideNextGate();
    updateStartBtnLabel();
  }
  function syncEnd(){ endTimeMs=performance.now()+secondsLeft*1000; }
  function startTimer(){ if(running) return; running=true; syncEnd(); loop(); updateStartBtnLabel(); updateClockColor(); markTimer(); }
  function stopTimer(){ running=false; if(rafId) cancelAnimationFrame(rafId); rafId=null; updateStartBtnLabel(); updateClockColor(); markTimer(); }
  function loop(){
    if(!running) return;
    const remaining=Math.max(0,Math.ceil((endTimeMs-performance.now())/1000));
    if(remaining!==secondsLeft){ secondsLeft=remaining; $('#clock').textContent=secsToClock(secondsLeft); updateProgress(); }
    if(secondsLeft<=0){
      // Section finished
      if(currentIndex<currentSession.length-1){
        stopTimer();
        awaitingNext = true;
        showNextGate();
        beep();
        markTimer();
        return;
      }else{
        stopTimer(); beep(); sessionStarted=false; updateStartBtnLabel(); markTimer(); alert('Session complete! 🎉'); return;
      }
    }
    rafId=requestAnimationFrame(loop);
  }
  const markTimer = ()=>{
    timerState={ sessionStarted,running,currentIndex,secondsLeft,lastSyncTs:Date.now(), awaitingNext };
    saveTimerLocal();
  };

  // Gate controls
  function showNextGate(){ readyNextBtn.classList.remove('hidden'); updateStartBtnLabel(); }
  function hideNextGate(){ readyNextBtn.classList.add('hidden'); updateStartBtnLabel(); }
  readyNextBtn.onclick = ()=>{
    if(!awaitingNext) return;
    awaitingNext=false;
    hideNextGate();
    if(currentIndex<currentSession.length-1){
      currentIndex++;
      secondsLeft=minsToSecs(currentSession[currentIndex].minutes||0);
      syncEnd();
      startTimer();
      renderAll();
      markTimer();
    }
  };

  startBtn.onclick = ()=>{
    if(!currentSession.length) return;
    if(awaitingNext) return; // wait for explicit confirmation
    if(!sessionStarted){ currentIndex=0; secondsLeft=minsToSecs(currentSession[0].minutes||0); totalSessionSecs=scheduleTotalSecs(currentSession); sessionStarted=true; markTimer(); startTimer(); }
    else{ running?stopTimer():startTimer(); }
  };
  prevBtn.onclick = ()=>{ awaitingNext=false; hideNextGate(); if(currentIndex>0){ currentIndex--; secondsLeft=minsToSecs(currentSession[currentIndex].minutes||0); if(running) syncEnd(); renderAll(); markTimer(); } updateStartBtnLabel(); };
  nextBtn.onclick = ()=>{ awaitingNext=false; hideNextGate(); if(currentIndex<currentSession.length-1){ currentIndex++; secondsLeft=minsToSecs(currentSession[currentIndex].minutes||0); if(running) syncEnd(); renderAll(); markTimer(); } else stopTimer(); updateStartBtnLabel(); };
  resetBtn.onclick = ()=>{ awaitingNext=false; hideNextGate(); stopTimer(); sessionStarted=false; currentIndex=0; secondsLeft=minsToSecs((currentSession[0]||{}).minutes||0); renderAll(); updateStartBtnLabel(); markTimer(); };

  function buildProgress(){
    const sched=currentSession; const total=scheduleTotalSecs(sched)||1;
    progressSegments.innerHTML=''; legend.innerHTML=''; progressTicks.innerHTML='';
    sched.forEach(sec=>{ const w=(minsToSecs(sec.minutes||0)/total)*100; const seg=document.createElement('div'); seg.className='h-full relative bg-white/50'; seg.style.width=`${w}%`; progressSegments.appendChild(seg); });
    let cum=0; for(let i=1;i<sched.length;i++){ cum+=minsToSecs(sched[i-1].minutes||0); const pct=(cum/total)*100; const tick=document.createElement('div'); Object.assign(tick.style,{position:'absolute',left:pct+'%',top:'0',bottom:'0',width:'2px',background:'rgba(0,0,0,.55)'}); progressTicks.appendChild(tick); }
    sched.forEach((sec,i)=>{ const chip=document.createElement('button'); chip.type='button'; chip.className='chip'; chip.dataset.idx=String(i); chip.innerHTML=`${escapeHtml(sec.name||'')} <span class="opacity-80">(${sec.minutes||0}m)</span>`; chip.onclick=()=>jumpToSection(i); legend.appendChild(chip); });
    updateProgress();
  }
  function updateLegendActive(){ legend.querySelectorAll('.chip').forEach((el, i)=> el.classList.toggle('chip-active', i===currentIndex)); }
  function updateProgress(){
    const sched=currentSession; const total=scheduleTotalSecs(sched);
    if(!total){ progressFill.style.width='0%'; progressPctEl.textContent='0%'; return; }
    const pct=Math.min(100,Math.max(0,(elapsedSeconds(sched,currentIndex,secondsLeft)/total)*100));
    progressFill.style.width = pct + '%';
    progressPctEl.textContent = Math.floor(pct) + '%';
    updateLegendActive();
    updateStartBtnLabel();
  }
  function pctFromEvent(e){ const rect=progressHost.getBoundingClientRect(); const x=(e.clientX ?? (e.touches?.[0]?.clientX ?? 0))-rect.left; return Math.max(0,Math.min(1,x/rect.width)); }
  function jumpFromPct(p){
    const sched=currentSession; const total=scheduleTotalSecs(sched); let target=p*total; let cum=0;
    for(let i=0;i<sched.length;i++){
      const dur=minsToSecs(sched[i].minutes||0);
      if(target<cum+dur){
        currentIndex=i;
        secondsLeft=Math.max(0,Math.ceil(dur-(target-cum)));
        if(running) syncEnd();
        renderAll();
        markTimer();
        awaitingNext=false;
        hideNextGate();
        updateStartBtnLabel();  // reflect Start vs Resume after manual scrub
        return;
      }
      cum+=dur;
    }
    currentIndex=sched.length-1; secondsLeft=0; stopTimer(); renderAll(); markTimer(); awaitingNext=false; hideNextGate(); updateStartBtnLabel();
  }
  let scrubbing=false;
  scrubOverlay.addEventListener('pointerdown',(e)=>{scrubbing=true;scrubOverlay.setPointerCapture(e.pointerId);jumpFromPct(pctFromEvent(e));});
  scrubOverlay.addEventListener('pointermove',(e)=>{if(scrubbing)jumpFromPct(pctFromEvent(e));});
  scrubOverlay.addEventListener('pointerup',()=>{scrubbing=false;});
  scrubOverlay.addEventListener('pointercancel',()=>{scrubbing=false;});

  function jumpToSection(i){
    if(!currentSession[i]) return;
    awaitingNext=false; hideNextGate();
    currentIndex=i; secondsLeft=minsToSecs(currentSession[i].minutes||0);
    if(running) syncEnd();
    renderAll();
    markTimer();
    updateStartBtnLabel();
  }

  /*************** Helpers (shared with Saved Outlines parity) ***************/
  function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function parseDropPayload(dt){
    let data = ''; const types = dt?.types ? Array.from(dt.types) : [];
    if(types.includes('text/plain')) data = dt.getData('text/plain');
    if(!data && types.includes('text')) data = dt.getData('text');
    if(!data) data = dt.getData('application/json') || dt.getData('Text') || '';
    try{ return JSON.parse(data); }catch{ return null; }
  }
  function normalizeUrl(input){
    let u = (input || '').trim();
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;
    u = u.replace(/^\/\//,'');
    const slash = u.indexOf('/');
    let host = slash >= 0 ? u.slice(0, slash) : u;
    const rest = slash >= 0 ? u.slice(slash) : '';
    if(!/^www\./i.test(host)){
      const parts = host.split('.');
      if(parts.length === 2){ host = 'www.' + host; }
    }
    return 'https://' + host + rest;
  }
  function openWidgetEditor(widget, onSave, onCancel){
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-panel max-w-[520px]">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Edit link</h3>
          <button class="btn-xxs" data-close="1">✕</button>
        </div>
        <div class="grid gap-2">
          <label class="text-sm">Title
            <input id="wLabel" class="input mt-1" value="${escapeHtml(widget.label || '')}"/>
          </label>
          <label class="text-sm">URL
            <input id="wUrl" class="input mt-1" value="${escapeHtml(widget.url || '')}" placeholder="https://… or aimchess.com"/>
          </label>
          <label class="text-sm">Icon type
            <select id="wIcon" class="input mt-1">
              <option value="emoji" ${widget.icon!=='img'?'selected':''}>Emoji/Text</option>
              <option value="img"   ${widget.icon==='img'?'selected':''}>Image URL</option>
            </select>
          </label>
          <label class="text-sm" id="emojiRow">Emoji/Text
            <input id="wEmoji" class="input mt-1" value="${escapeHtml(widget.emoji || '')}" placeholder="♟️"/>
          </label>
          <label class="text-sm hidden" id="imgRow">Image URL
            <input id="wImg" class="input mt-1" value="${escapeHtml(widget.img || '')}" placeholder="https://…/icon.png"/>
          </label>
        </div>
        <div class="mt-3 flex items-center justify-end gap-2">
          <button class="px-3 py-2 rounded-xl border border-[var(--border)]" data-close="1">Cancel</button>
          <button id="wSave" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white">Save</button>
        </div>
      </div>`;
    document.body.appendChild(modal);

    const iconSel = modal.querySelector('#wIcon');
    const emojiRow = modal.querySelector('#emojiRow');
    const imgRow   = modal.querySelector('#imgRow');
    const syncRows = ()=>{
      const useImg = iconSel.value==='img';
      emojiRow.classList.toggle('hidden', useImg);
      imgRow.classList.toggle('hidden', !useImg);
    };
    syncRows(); iconSel.addEventListener('change', syncRows);

    const close = ()=>{ modal.classList.add('hidden'); setTimeout(()=>modal.remove(), 140); };
    modal.addEventListener('click', (e)=>{ if(e.target.dataset.close==='1'){ onCancel && onCancel(); close(); } });
    const onEsc = (e)=>{ if(e.key==='Escape'){ onCancel && onCancel(); close(); document.removeEventListener('keydown', onEsc);} };
    document.addEventListener('keydown', onEsc);

    modal.querySelector('#wSave').onclick = ()=>{
      const label = modal.querySelector('#wLabel').value.trim() || 'Untitled';
      let url     = modal.querySelector('#wUrl').value.trim() || '';
      url = normalizeUrl(url);
      const icon  = iconSel.value==='img' ? 'img' : 'emoji';
      let emoji='', img='';
      if(icon==='img') img = modal.querySelector('#wImg').value.trim();
      else emoji = modal.querySelector('#wEmoji').value.trim() || '🔗';
      onSave({ label, url, icon, emoji, img });
      onCancel = null;
      close();
    };
  }

  /*************** Current panel (Home) ***************/
  let isEditingSection=false;
  editSectionBtn.onclick = ()=>{ isEditingSection=!isEditingSection; updateEditUI(); };
  function updateEditUI(){
    shelfWrap.classList.toggle('hidden', !isEditingSection);
    clearSectionLinksBtn.classList.toggle('hidden', !isEditingSection);
    editSectionBtn.textContent = isEditingSection ? 'Save Changes' : 'Edit Section';
    renderCurrentLinks(); renderShelf();
  }
  function currentSectionRef(){ return currentSession[currentIndex]; }

  // Add widget (same UX as saved outlines: create placeholder -> open editor)
  addWidgetBtn.onclick = ()=>{
    if(!isEditingSection) editSectionBtn.click();
    const wid = 'W'+Date.now().toString(36);
    const placeholder = { id: wid, label:'', url:'', icon:'emoji', emoji:'🔗', img:'' };
    widgetShelf = [...widgetShelf, placeholder]; saveShelf(); renderShelf();
    const onCancel = ()=>{
      const idx = widgetShelf.findIndex(x=>x.id===wid);
      if(idx>=0){ widgetShelf.splice(idx,1); saveShelf(); renderShelf(); }
    };
    openWidgetEditor(placeholder, (upd)=>{
      upd.url = normalizeUrl(upd.url);
      const it = widgetShelf.find(x=>x.id===wid);
      if(it){ Object.assign(it, upd); saveShelf(); renderShelf(); }
    }, onCancel);
  };
  resetShelfBtn.onclick = ()=>{
    if(!confirm('Reset link shelf to defaults?')) return;
    widgetShelf = [
      { id:'w_lichess',  label:'Lichess',          url:'https://lichess.org',          icon:'img',   img:'https://lichess1.org/assets/logo/lichess-favicon-256.png' },
      { id:'w_analysis', label:'Lichess Analysis', url:'https://lichess.org/analysis', icon:'img',   img:'https://lichess1.org/assets/logo/lichess-favicon-256.png' },
      { id:'w_chessable',label:'Chessable',        url:'https://www.chessable.com',    icon:'emoji', emoji:'📘' }
    ];
    saveShelf(); renderShelf();
  };

  // Shelf cards (same structure as saved outlines)
  function widgetCardHTML(w){
    const iconHtml = (w.icon==='img' && w.img)
      ? `<img src="${escapeHtml(w.img)}" alt="" class="rounded-[4px] object-cover" draggable="false" style="width:18px;height:18px;"/>`
      : `<span class="link-icon">${escapeHtml(w.emoji || '🔗')}</span>`;
    return `
      <div class="widget" data-wid="${escapeHtml(w.id)}">
        <div class="link-card draggable-shelf" draggable="${isEditingSection?'true':'false'}" data-wid="${escapeHtml(w.id)}" title="${escapeHtml(w.url || '')}" style="cursor:${isEditingSection?'grab':'default'}">
          ${iconHtml}
          <div class="min-w-0">
            <div class="truncate" style="font-size:.95rem">${escapeHtml(w.label || 'Untitled')}</div>
            <div class="text-xs muted truncate">${escapeHtml(w.url || '')}</div>
          </div>
        </div>
        ${isEditingSection ? `<button class="bin" data-act="del-shelf" title="Delete from shelf">🗑️</button>` : ''}
      </div>`;
  }
  function renderShelf(){
    linkShelfDiv.innerHTML = (isEditingSection ? `<button class="add-pill" data-act="add-shelf"> Add</button>` : '')
      + widgetShelf.map(widgetCardHTML).join('');

    linkShelfDiv.querySelector('[data-act="add-shelf"]')?.addEventListener('click', ()=> addWidgetBtn.click());

    // Click to edit shelf item (same modal)
    linkShelfDiv.querySelectorAll('.draggable-shelf').forEach(card=>{
      card.addEventListener('click', ()=>{
        if(!isEditingSection) return;
        const w = widgetShelf.find(x=>x.id===card.dataset.wid); if(!w) return;
        openWidgetEditor(w, (upd)=>{
          upd.url = normalizeUrl(upd.url);
          Object.assign(w, upd); saveShelf(); renderShelf();
        });
      });
      // Drag from shelf → current section links
      card.addEventListener('dragstart', e=>{
        if(!isEditingSection){ e.preventDefault(); return; }
        const payloadStr = JSON.stringify({type:'shelf', id:card.dataset.wid});
        try{ e.dataTransfer.setData('text/plain', payloadStr); }catch{}
        e.dataTransfer.effectAllowed='copy';
        card.classList.add('drag-ghost');
      });
      card.addEventListener('dragend', ()=> card.classList.remove('drag-ghost'));
    });

    // Delete shelf item
    linkShelfDiv.querySelectorAll('[data-act="del-shelf"]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!isEditingSection) return;
        const wid = btn.closest('[data-wid]')?.dataset.wid || btn.parentElement?.dataset.wid;
        const idx = widgetShelf.findIndex(x=>x.id===wid);
        if(idx>=0){ widgetShelf.splice(idx,1); saveShelf(); renderShelf(); }
      });
    });
  }

  // Current section links (open link in view mode; edit modal in edit mode)
  function renderCurrentLinks(){
    const sec=currentSectionRef(); const arr=sec?.links||[];
    linksDiv.innerHTML = arr.map((w,i)=>`
      <div class="widget" data-link-idx="${i}">
        <div class="link-card section-link" draggable="${isEditingSection?'true':'false'}" data-idx="${i}">
          ${w.icon==='img' && w.img
              ? `<img src="${escapeHtml(w.img)}" alt="" class="rounded-[4px] object-cover" draggable="false" style="width:18px;height:18px;"/>`
              : `<span class="link-icon">${escapeHtml(w.emoji||'🔗')}</span>`}
          <span class="truncate max-w-[14rem]">${escapeHtml(w.label||'Untitled')}</span>
        </div>
        ${isEditingSection ? `<button class="bin" data-act="del-link" title="Delete">🗑️</button>` : ''}
      </div>`).join('');

    // Drag-reorder within bar
    linksDiv.querySelectorAll('.section-link').forEach(card=>{
      card.addEventListener('dragstart', e=>{
        if(!isEditingSection){ e.preventDefault(); return; }
        const index=Number(card.dataset.idx);
        const payloadStr = JSON.stringify({type:'reorder', index});
        try{ e.dataTransfer.setData('text/plain', payloadStr); }catch{}
        e.dataTransfer.effectAllowed='move';
        card.classList.add('drag-ghost');
      });
      card.addEventListener('dragend', ()=> card.classList.remove('drag-ghost'));

      // Click: edit in edit-mode; open link in view-mode
      card.addEventListener('click', ()=>{
        const i = Number(card.dataset.idx); const target = sec.links[i]; if(!target) return;
        if(isEditingSection){
          openWidgetEditor(target, (upd)=>{
            upd.url = normalizeUrl(upd.url);
            Object.assign(target, upd); saveCurrentSession(); renderCurrentLinks();
          });
        } else {
          const url = normalizeUrl(target.url||'');
          if(url) window.open(url, '_blank', 'noopener');
        }
      });
    });

    if(isEditingSection){
      linksDiv.querySelectorAll('[data-act="del-link"]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const pill = btn.closest('.widget')?.querySelector('.section-link');
          const i = Number(pill?.dataset.idx ?? -1);
          if(i>=0){ sec.links.splice(i,1); saveCurrentSession(); renderCurrentLinks(); }
        });
      });
    }
  }

  // Drop handlers (home links)
  let overCount = 0;
  linksDiv.addEventListener('dragenter', e=>{ if(!isEditingSection) return; overCount++; linksDiv.classList.add('drag-over-outline'); });
  linksDiv.addEventListener('dragleave', e=>{ if(!isEditingSection) return; overCount=Math.max(0, overCount-1); if(overCount===0) linksDiv.classList.remove('drag-over-outline'); });
  linksDiv.addEventListener('dragover', e=>{ if(!isEditingSection) return; e.preventDefault(); e.dataTransfer.dropEffect='copy'; });
  linksDiv.addEventListener('drop', e=>{
    if(!isEditingSection) return; e.preventDefault(); overCount=0; linksDiv.classList.remove('drag-over-outline');
    const payload = parseDropPayload(e.dataTransfer);
    if(!payload) return;
    const sec=currentSectionRef(); if(!sec) return;
    if(payload.type==='shelf'){
      const w=widgetShelf.find(x=>x.id===payload.id); if(!w) return;
      sec.links.push({ id:'l_'+Date.now()+Math.random().toString(16).slice(2), label:w.label, url:w.url, icon:w.icon, emoji:w.emoji||'', img:w.img||'' });
      saveCurrentSession(); renderCurrentLinks();
    } else if(payload.type==='reorder'){
      const from=payload.index; const cards=[...linksDiv.querySelectorAll('.section-link')];
      let to=cards.length; for(let i=0;i<cards.length;i++){ const r=cards[i].getBoundingClientRect(); if(e.clientY < r.top + r.height/2){ to=i; break; } }
      if(from===to || from==null || to==null) return; const [m]=sec.links.splice(from,1); sec.links.splice(to,0,m); saveCurrentSession(); renderCurrentLinks();
    }
  });

  sectionDescEl.addEventListener('input', ()=>{ const s=currentSession[currentIndex]; if(!s) return; sectionNotes[s.id] = sectionDescEl.value; saveNotes(); });

  /*************** Outline (Home) with interactive reorder ***************/
  function renderOutline(){
    outline.innerHTML = currentSession.map((s,i)=>
      `<li class="outline-row ${i===currentIndex?'outline-active':''}" data-id="${s.id}" draggable="true">
        <div class="flex items-center gap-3">
          <button class="text-left min-w-0 flex-1 truncate text-sm font-semibold focus:outline-none">${escapeHtml(s.name||'')}</button>
          <div class="flex items-center gap-2 shrink-0">
            <span class="text-xs w-16 text-right">${Number(s.minutes||0)}m</span>
            <button class="btn-xs" data-act="edit">Edit</button>
            <button class="btn-xs" data-act="delete">Delete</button>
          </div>
        </div>
      </li>`).join('');

    // Jump on click (not when clicking action buttons)
    outline.querySelectorAll('li[data-id]').forEach((li, idx)=>{
      li.addEventListener('click', (e)=>{ if(e.target.closest('[data-act]')) return; jumpToSection(idx); });
    });

    // Inline edit
    outline.querySelectorAll('[data-act="edit"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const li = btn.closest('li[data-id]'); const id = li.dataset.id; const idx=currentSession.findIndex(x=>x.id===id); if(idx<0) return;
        const cur=currentSession[idx];
        li.innerHTML = `
          <div class="flex items-center gap-2">
            <input class="input flex-1 text-sm" id="edtTitle" value="${escapeHtml(cur.name||'')}" />
            <input class="input w-24 text-sm" id="edtValue" type="number" step="0.1" min="0.01" value="${(+cur.minutes||0).toFixed(2).replace(/\.00$/,'')}" />
            <select id="edtUnit" class="input h-9 w-20 text-sm">
              <option value="minutes" selected>min</option>
              <option value="seconds">sec</option>
              <option value="hours">hr</option>
            </select>
            <button class="btn-xxs" id="edtSave">Save</button>
            <button class="btn-xxs" id="edtCancel">Cancel</button>
          </div>`;
        const edtTitle=li.querySelector('#edtTitle'), edtValue=li.querySelector('#edtValue'), edtUnit=li.querySelector('#edtUnit');
        const toMinutes = (value, unit)=>{ const v=Number(value)||0; if(unit==='seconds') return v/60; if(unit==='hours') return v*60; return v; };
        const saveInline = ()=>{
          cur.name = edtTitle.value.trim() || cur.name;
          cur.minutes = Math.max(0.01, toMinutes(edtValue.value, edtUnit.value));
          saveCurrentSession();
          if(currentSession[currentIndex]?.id===cur.id){ secondsLeft = Math.min(secondsLeft, minsToSecs(cur.minutes)); if(running) syncEnd(); markTimer(); }
          renderOutline(); buildProgress(); updateProgress(); renderCurrent();
        };
        li.querySelector('#edtSave').onclick = saveInline; li.querySelector('#edtCancel').onclick = renderOutline;
      });
    });

    // Delete
    outline.querySelectorAll('[data-act="delete"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.closest('li[data-id]').dataset.id;
        const delIdx = currentSession.findIndex(s=>s.id===id);
        if(delIdx<0 || !confirm('Delete this section?')) return;
        const deletingCurrent = delIdx === currentIndex;
        currentSession.splice(delIdx,1);
        awaitingNext=false; hideNextGate();
        if(currentSession.length===0){ stopTimer(); sessionStarted=false; currentIndex=0; secondsLeft=0; }
        else{
          if(delIdx < currentIndex) currentIndex--;
          if(deletingCurrent){ currentIndex = Math.min(currentIndex, currentSession.length-1); secondsLeft = minsToSecs(currentSession[currentIndex].minutes||0); if(running) syncEnd(); }
        }
        saveCurrentSession(); renderAll(); markTimer();
      });
    });

    // Drag reorder with live placeholder (shows section title)
    let dragging = null;
    const makePh = (h, titleText)=>{ 
      const ph = document.createElement('li'); 
      ph.className='outline-row drop-placeholder'; 
      ph.style.setProperty('--ph', `${Math.max(36,h)}px`); 
      ph.innerHTML = `<div class="text-xs muted px-2 truncate">${escapeHtml(titleText||'')}</div>`; 
      return ph; 
    };

    outline.querySelectorAll('li[data-id]').forEach((li, idx)=>{
      li.addEventListener('dragstart', (e)=>{
        const titleText = (li.querySelector('button')?.textContent || '').trim();
        dragging = { from: idx, el: li, placeholder: makePh(li.offsetHeight, titleText) };
        li.classList.add('dragging');
        li.after(dragging.placeholder);
        try{ e.dataTransfer.setData('text/plain', JSON.stringify({type:'outline-move', from: idx})); }catch{}
        e.dataTransfer.effectAllowed='move';
      });
      li.addEventListener('dragend', ()=>{
        li.classList.remove('dragging');
        dragging?.placeholder?.remove();
        dragging = null;
      });

      const onOver = (e)=>{
        if(!dragging) return;
        e.preventDefault();
        const r = li.getBoundingClientRect();
        const before = e.clientY < (r.top + r.height/2);
        const ph = dragging.placeholder;
        if(before){
          if(li.previousSibling !== ph) outline.insertBefore(ph, li);
        }else{
          if(li.nextSibling !== ph) li.after(ph);
        }
      };
      li.addEventListener('dragover', onOver);
      li.addEventListener('dragenter', onOver);
    });

    outline.addEventListener('dragover', (e)=>{
      if(!dragging) return; e.preventDefault();
      if(!outline.contains(dragging.placeholder)) outline.appendChild(dragging.placeholder);
    });
    outline.addEventListener('drop', (e)=>{
      if(!dragging) return; e.preventDefault();
      const from = dragging.from;

      const rows = Array.from(outline.querySelectorAll('li.outline-row'));
      const phIndex = rows.indexOf(dragging.placeholder);
      const to = phIndex < 0 ? rows.length-1 : phIndex;

      const finalTo = (to > from) ? to - 1 : to;

      if(from !== finalTo && from >= 0 && finalTo >= 0){
        const [moved] = currentSession.splice(from,1);
        currentSession.splice(finalTo,0,moved);

        if(currentIndex === from) currentIndex = finalTo;
        else if(currentIndex > from && currentIndex <= finalTo) currentIndex -= 1;
        else if(currentIndex < from && currentIndex >= finalTo) currentIndex += 1;

        saveCurrentSession(); renderOutline(); buildProgress(); updateProgress(); renderCurrent();
      }
      dragging.el.classList.remove('dragging');
      dragging.placeholder.remove();
      dragging = null;
    });

    if(totalMins) totalMins.textContent=`Total: ${Math.round(scheduleTotalSecs(currentSession)/60)} minutes`;
  }

  addOutlineItemBtn.onclick = ()=>{ inlineAddRow.classList.remove('hidden'); addTitleInput.value=''; addMinsInput.value=''; addTitleInput.focus(); };
  addCancelBtn.onclick = ()=> inlineAddRow.classList.add('hidden');
  addConfirmBtn.onclick = ()=>{
    const title=(addTitleInput.value||'').trim() || 'New section'; const mins=Math.max(0.25, Number(addMinsInput.value)||5);
    currentSession.push({ id:'S'+Date.now(), name:title, minutes:mins, links:[] });
    inlineAddRow.classList.add('hidden'); saveCurrentSession(); renderAll(); markTimer();
  };

  /*************** Saved Outlines module wiring ***************/
  const homeSavedScroller = $('#homeSavedScroller');
  function renderHomeSavedBar(){
    const activeId = (timerState && timerState.outlineId) || null;
    homeSavedScroller.innerHTML =
      (savedOutlines.length
        ? savedOutlines.map(o=>`
            <button type="button"
                    class="chip ${o.id===activeId ? 'chip-active' : ''}"
                    data-oid="${escapeHtml(o.id)}"
                    title="${escapeHtml(o.title || 'Outline')}">
              ${escapeHtml(o.title || 'Untitled')}
            </button>`).join('')
        : `<div class="text-xs muted">No saved outlines yet.</div>`);

    homeSavedScroller.querySelectorAll('[data-oid]').forEach(btn=>{
      btn.onclick = ()=>{
        const o = savedOutlines.find(x=>x.id===btn.dataset.oid);
        if(o){
          applyOutlineToCurrent(o);
          requestAnimationFrame(renderHomeSavedBar); // re-highlight
        }
      };
    });
  }
  function applyOutlineToCurrent(outlineObj){
    const clone = outlineObj.sections.map(s=>({ id:s.id||('S'+Math.random().toString(16).slice(2)), name:s.name, minutes:s.minutes, links:structuredClone(s.links||[]) }));
    currentSession = clone;
    sectionNotes = {};
    clone.forEach(sec=>{ const src = outlineObj.sections.find(ss=>ss.id===sec.id); if(src && src.desc!=null) sectionNotes[sec.id] = src.desc; });
    timerState = { sessionStarted:false, running:false, currentIndex:0, secondsLeft:minsToSecs((clone[0]||{}).minutes||0), outlineId: outlineObj.id, lastSyncTs: Date.now(), awaitingNext:false };
    awaitingNext=false; hideNextGate();
    saveCurrentSession(); saveNotes(); saveTimerLocal(); renderAll(); updateStartBtnLabel();
  }

  const { renderSavedOutlines } = setupSavedOutlines({
    getSavedOutlines: ()=> savedOutlines,
    setSavedOutlines: (arr)=>{ savedOutlines = arr; },
    saveOutlinesLocal,
    getWidgetShelf: ()=> widgetShelf,
    setWidgetShelf: (arr)=>{ widgetShelf = arr; saveShelf(); },
    applyOutline: applyOutlineToCurrent,
    touchCloud,
    renderHomeSavedBar
  });

  /*************** Auth modal UI ***************/
  const authOpenBtn = $('#authOpenBtn'); const userBadge = $('#userBadge'); const userEmail = $('#userEmail'); const signOutBtn = $('#signOutBtn');
  const authModal = $('#authModal'); const authTitle=$('#authTitle'); const authSubtitle=$('#authSubtitle');
  const emailInput=$('#emailInput'); const passInput=$('#passInput');
  const googleBtn=$('#googleBtn'); const emailSignInBtn=$('#emailSignInBtn'); const emailSignUpBtn=$('#emailSignUpBtn'); const emailResetBtn=$('#emailResetBtn');
  const signinRow=$('#signinRow'); const signupRow=$('#signupRow'); const toggleAuthMode=$('#toggleAuthMode');

  let authMode='signin';
  function showModal(modal){ modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
  function hideModal(modal){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
  function setAuthMode(mode){
    authMode=mode;
    const isSignUp = mode==='signup';
    signinRow.classList.toggle('hidden', isSignUp);
    signupRow.classList.toggle('hidden', !isSignUp);
    toggleAuthMode.textContent = isSignUp ? 'Already have an account? Sign in' : 'New here? Create an account';
    authTitle.textContent = isSignUp ? 'Create your account' : 'Welcome back';
    authSubtitle.textContent = isSignUp ? 'Make an account to enable cloud sync.' : 'Sign in to sync your data across devices.';
  }
  toggleAuthMode.onclick = ()=> setAuthMode(authMode==='signin'?'signup':'signin');
  authOpenBtn.onclick = ()=>{ emailInput.value=''; passInput.value=''; setAuthMode('signin'); showModal(authModal); };
  authModal.addEventListener('click', (e)=>{ if(e.target.dataset.close==='1') hideModal(authModal); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ hideModal(authModal); hideModal(settingsModal); } });

  googleBtn.onclick = ()=> signInWithPopup(auth, provider).catch(err=> alert(err.message||'Google sign-in failed'));
  emailSignInBtn.onclick = async ()=>{
    try{ await signInWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value); }
    catch(e){ alert(e.message||'Sign-in failed'); }
  };
  emailSignUpBtn.onclick = async ()=>{
    try{ await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value); }
    catch(e){ alert(e.message||'Sign-up failed'); }
  };
  emailResetBtn.onclick = async ()=>{
    try{ if(!emailInput.value.trim()) return alert('Enter your email first.'); await sendPasswordResetEmail(auth, emailInput.value.trim()); alert('Reset email sent.'); }
    catch(e){ alert(e.message||'Reset failed'); }
  };
  signOutBtn.onclick = ()=> signOut(auth);

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    if(user){
      authOpenBtn.classList.add('hidden'); userBadge.classList.remove('hidden'); userEmail.textContent = user.email || user.uid; setCloudMode('Syncing…');
      hideModal(authModal);
      try{
        const snap = await getDoc(userDocRef(user.uid));
        if(snap.exists()){
          const d = snap.data()||{};
          if(d.currentSession) currentSession = d.currentSession;
          if(d.notes) sectionNotes = d.notes;
          if(d.prefs) prefs = d.prefs;
          if(d.widgetShelf) widgetShelf = d.widgetShelf;
          if(d.savedOutlines) savedOutlines = d.savedOutlines;
          if(d.timer) timerState = d.timer;
          applyTheme(prefs.theme||{});
          applySplitRatio(prefs.splitRatio||56);
          setTimerFromState(timerState); renderAll(); renderHomeSavedBar(); setCloudMode('Saved to cloud ✓');
        } else { setCloudMode('Cloud sync on'); }
      }catch{ setLocalMode('Cloud read failed'); }
    } else {
      authOpenBtn.classList.remove('hidden'); userBadge.classList.add('hidden'); setLocalMode('Local mode');
    }
  });

  /*************** Settings modal UI ***************/
  const settingsModal = $('#settingsModal');
  const setBg=$('#setBg'), setFg=$('#setFg'), setAccent=$('#setAccent'), setBorder=$('#setBorder'), setBorderW=$('#setBorderW'), setFocusDefault=$('#setFocusDefault');
  const settingsSaveBtn=$('#settingsSaveBtn'), settingsResetBtn=$('#settingsResetBtn');
  function applyTheme(t){
    document.documentElement.style.setProperty('--bg', t.bg || '#ffffff');
    document.documentElement.style.setProperty('--fg', t.fg || '#0f172a');
    document.documentElement.style.setProperty('--accent', t.accent || '#0ea5e9');
    document.documentElement.style.setProperty('--border', t.border || '#94a3b8');
    document.documentElement.style.setProperty('--panel', t.panel || '#ffffff');
    document.documentElement.style.setProperty('--panel-muted', t.panelMuted || '#f8fafc');
    document.documentElement.style.setProperty('--borderW', (t.borderW ?? 2) + 'px');
  }
  function openSettings(){
    setBg.value = prefs.theme?.bg || '#ffffff';
    setFg.value = prefs.theme?.fg || '#0f172a';
    setAccent.value = prefs.theme?.accent || '#0ea5e9';
    setBorder.value = prefs.theme?.border || '#94a3b8';
    setBorderW.value = String(prefs.theme?.borderW ?? 2);
    setFocusDefault.checked = !!prefs.focusDefault;
    showModal(settingsModal);
  }
  function closeSettings(){ hideModal(settingsModal); }
  document.querySelectorAll('#settingsModal [data-close="1"]').forEach(b=> b.addEventListener('click', closeSettings));
  settingsModal.addEventListener('click', (e)=>{ if(e.target.dataset.close==='1') closeSettings(); });
  $('#settingsBtn').onclick = openSettings;
  settingsSaveBtn.onclick = ()=>{
    prefs.theme = {
      bg:setBg.value, fg:setFg.value, accent:setAccent.value, border:setBorder.value, borderW:Math.max(0, Number(setBorderW.value)||2)
    };
    prefs.focusDefault = !!setFocusDefault.checked;
    applyTheme(prefs.theme); savePrefs(); closeSettings();
  };
  settingsResetBtn.onclick = ()=>{
    prefs.theme = { bg:'#ffffff', fg:'#0f172a', accent:'#0ea5e9', border:'#94a3b8', borderW:2 };
    prefs.focusDefault = false;
    applyTheme(prefs.theme); savePrefs(); openSettings();
  };
  applyTheme(prefs.theme||{});

  /*************** Initial render ***************/
  function renderCurrent(){
    const s=currentSession[currentIndex]; if(!s){ currentTitleEl.textContent='—'; sectionDescEl.value=''; linksDiv.innerHTML=''; return; }
    currentTitleEl.textContent = s.name || 'Untitled';
    sectionNotes[s.id] = sectionNotes[s.id] || '';
    sectionDescEl.value = sectionNotes[s.id];
    renderCurrentLinks();
    $('#clock').textContent = secsToClock(secondsLeft);
  }
  function renderAll(){ renderOutline(); buildProgress(); updateProgress(); renderCurrent(); }

  // Beep
  let ctx=null, osc=null;
  function beep(){ try{ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); osc=ctx.createOscillator(); const g=ctx.createGain(); osc.connect(g); g.connect(ctx.destination); osc.type='square'; osc.frequency.value=880; g.gain.value=.05; osc.start(); setTimeout(()=>{ osc.stop(); }, 120); }catch{} }

  setTimerFromState(timerState); renderAll(); renderHomeSavedBar();
</script>
</body>
</html>
